<!DOCTYPE html>
<style>

body {
  background-image: url(http://www.pixelstalk.net/wp-content/uploads/2016/08/Free-Chalkboard-Backgrounds.jpg);
  justify-content: flex-end;
  color: white;
}

#info-box {
  word-wrap: break-word;
  border: 5px solid yellow;
}

.header-text {
  /*flex: none;*/
}

.states :hover {
  fill: red;
}
.state-borders {
  fill: none;
  stroke: #f5f5f5;
  stroke-width: .5px;
  stroke-linejoin: none;
  stroke-linecap: none;
  pointer-events: none;
}

</style>

<script
src="https://code.jquery.com/jquery-3.2.1.min.js"
integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
crossorigin="anonymous"></script>
<script src="./pp_api_request.js"></script>
<!-- above script contents without PP_API_KEY:
    $.ajax({
      url: 'https://api.propublica.org/congress/v1/115/senate/members.json',
      beforeSend: function(xhr) {
           xhr.setRequestHeader("X-API-Key", PP_API_KEY);
      }, success: (data) => window.ajax_success(data)
    });
 -->
<h1 class="header-text">Senators Map</h1>
<svg width="960" height="600"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>

<script>

  window.ajax_success = function(data) {
    window.result_object = data.results;
    window.senators = data.results[0].members;
    mmm.forEach( state => {
      let sens = senators.filter(senator => senator.state === state.state_abbr);
      const partyColor = (sens) => {
        let repub = 0, dem = 0, othr = 0;
        sens.forEach(sen => {
          switch (sen.party) {
            case "R":
              repub++;
              break;
            case "D":
              dem++;
              break;
            default:
              othr++;
          }
        });
        switch ([repub,dem].toString()) {
          case '2,0':
            return 'red';
          case '1,1':
            return 'purple';
          case '0,2':
            return 'blue';
          default:
            return 'gray';
        }
      };
      state.color = partyColor(sens);
      state.style.fill = state.color;
    });
  }

var statesGeoJSON = 'https://d3js.org/us-10m.v1.json';

var svg = d3.select("svg");

var path = d3.geoPath();

d3.json(statesGeoJSON, function(error, us) {
  if (error) throw error;

  svg.append("g")
      .attr("class", "states")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.states).features)
    .enter().append("path")
      .attr("d", path);

  window.mmm = Array.from($(".states")[0].children);

  const handleClick = (e) => {
    let stateName = e.target.state_abbr;
    let sens = senators.filter( senator => senator.state === stateName ).map( senator => senator.first_name + ' ' + senator.last_name );
    $('#header').replaceWith(`<h1 id='header'>${state_hash[stateName]}</h1>`);
    $('#state-info').replaceWith(`<h2 id='state-info'>${state_hash[stateName] + ' senators: ' + sens[0] + ' and ' + sens[1]}</h2>`);


    let formatted_name_0 = sens[0].replace('Bob Casey','Bob Casey Jr.').replace('Jack Reed','Jack Reed (politician)').replace('Edward Markey', 'Ed Markey').replace('Margaret Hassan', 'Maggie Hassan').replace('Richard Durbin','Dick Durbin').replace('Gary Peters','Gary Peters (politician)').replace('Shelley Capito', 'Shelley Moore Capito').replace('James Inhofe','Jim Inhofe').replace(' ', '%20').replace('Charles', 'Chuck').replace('Bernard', 'Bernie');
    let formatted_name_1 = sens[1].replace('Michael Enzi', 'Mike Enzi').replace('Robert Menendez', 'Bob Menendez').replace('Christopher Murphy', 'Chris Murphy (Connecticut politician)').replace('Ron Johnson','Ron Johnson (U.S. politician)').replace(' III', '').replace(' ', '%20').replace('Charles', 'Chuck').replace('Bernard', 'Bernie').replace('Patrick','Pat');
    $.getJSON(`https://en.wikipedia.org/w/api.php?action=query&titles=${formatted_name_0}&format=json&prop=pageimages&origin=*`, function(data) {
        window.wiki_result = data.query.pages;
        test_dest_img(0, wiki_result[Object.keys(window.wiki_result)[0]]);
    });
    $.getJSON(`https://en.wikipedia.org/w/api.php?action=query&titles=${formatted_name_1}&format=json&prop=pageimages&origin=*`, function(data) {
        window.wiki_result = data.query.pages;
        test_dest_img(1, wiki_result[Object.keys(window.wiki_result)[0]]);
    });
    const test_dest_img = (num, { thumbnail }) => {
      let piccy = thumbnail ? thumbnail.source : 'https://cdn2.iconfinder.com/data/icons/ios-7-icons/50/user_male2-128.png';
      $(`#test-img-${num}`).attr('src', piccy);
    }

  }

  const state_ids_obj = { 0: "AR", 1: "CA", 2: "IL", 3: "KS", 4: "MS", 5: "OH", 6: "TX", 7: "AL", 8: "IA", 9: "LA", 10: "MN", 11: "MO", 12: "NE", 13: "AZ", 14: "CO", 15: "IN", 16: "MI", 17: "MT", 18: "NY", 19: "OR", 20: "VA", 21: "WY", 22: "NC", 23: "OK", 24: "TN", 25: "WI", 26: "AK", 27: "VT", 28: "ND", 29: "GA", 30: "ME", 31: "RI", 32: "WV", 33: "ID", 34: "SD", 35: "NM", 36: "WA", 37: "PA", 38: "FL", 39: "UT", 40: "KY", 41: "NH", 42: "SC", 43: "NV", 44: "HI", 45: "NJ", 46: "CT", 47: "MD", 48: "MA", 49: "DE"}
  const state_hash = {
    "AL": "Alabama", "AK": "Alaska", "AS": "American Samoa", "AZ": "Arizona", "AR": "Arkansas", "CA": "California", "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware", "DC": "District Of Columbia", "FM": "Federated States Of Micronesia", "FL": "Florida", "GA": "Georgia", "GU": "Guam", "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "IA": "Iowa", "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MH": "Marshall Islands", "MD": "Maryland", "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri", "MT": "Montana", "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey", "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota", "MP": "Northern Mariana Islands", "OH": "Ohio", "OK": "Oklahoma", "OR": "Oregon", "PW": "Palau", "PA": "Pennsylvania", "PR": "Puerto Rico", "RI": "Rhode Island", "SC": "South Carolina", "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont", "VI": "Virgin Islands", "VA": "Virginia", "WA": "Washington", "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming"
  }

  const handleHoverOn = (e) => {
    e.target.style.fill = 'yellow';
  }

  const handleHoverOff = (e) => {
    e.target.style.fill = e.target.color;
  }

  const handleFocus = (e) => {
    e.target.style.fill = 'orange';
  }

  let iter = 0;

  window.mmm.forEach( state => {
    state.special_id = iter;
    iter ++;
    state.state_abbr = state_ids_obj[state.special_id];
    state.onclick = handleClick;
    let abbr = state.state_abbr;
    state.onmouseover = handleHoverOn;
    state.onmouseout = handleHoverOff;
    state.onfocus = handleFocus;

  } );
  svg.append("path")
      .attr("class", "state-borders")
      .attr("d", path(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; })));
});

</script>
<div id="info-box">
  <h1 id='header'>Click on a State</h1>
  <section id='state-info'>
  </section>
  <img id='test-img-0' />
  <img id='test-img-1' />
</div>
